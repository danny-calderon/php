class Publicacion {
    protected $titulo;
    protected $autor;
    protected $anio;
    protected static $jsonFile = 'data.json';

    public function __construct($titulo, $autor, $anio) {
        $this->titulo = $titulo;
        $this->autor = $autor;
        $this->anio = $anio;
    }

    public function toArray() {
        return [
            'titulo' => $this->titulo,
            'autor' => $this->autor,
            'anio' => $this->anio
        ];
    }

    protected static function readJson() {
        if (!file_exists(self::$jsonFile)) {
            return [];
        }
        return json_decode(file_get_contents(self::$jsonFile), true) ?? [];
    }

    protected static function writeJson($data) {
        file_put_contents(self::$jsonFile, json_encode($data, JSON_PRETTY_PRINT));
    }

    public static function getAll() {
        return self::readJson();
    }

    public static function delete($titulo) {
        $data = self::readJson();
        $data = array_filter($data, fn($item) => $item['titulo'] !== $titulo);
        self::writeJson(array_values($data));
    }
}

class Libro extends Publicacion {
    private $genero;

    public function __construct($titulo, $autor, $anio, $genero) {
        parent::__construct($titulo, $autor, $anio);
        $this->genero = $genero;
    }

    public function toArray() {
        $data = parent::toArray();
        $data['genero'] = $this->genero;
        return $data;
    }

    public function save() {
        $data = self::readJson();
        $data[] = $this->toArray();
        self::writeJson($data);
    }
}

class Revista extends Publicacion {
    private $edicion;

    public function __construct($titulo, $autor, $anio, $edicion) {
        parent::__construct($titulo, $autor, $anio);
        $this->edicion = $edicion;
    }

    public function toArray() {
        $data = parent::toArray();
        $data['edicion'] = $this->edicion;
        return $data;
    }

    public function save() {
        $data = self::readJson();
        $data[] = $this->toArray();
        self::writeJson($data);
    }
}

// index.php para manejar peticiones CRUD
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $titulo = $_POST['titulo'] ?? '';
    $autor = $_POST['autor'] ?? '';
    $anio = $_POST['anio'] ?? '';
    $tipo = $_POST['tipo'] ?? '';
    
    if ($tipo === 'libro') {
        $genero = $_POST['genero'] ?? '';
        (new Libro($titulo, $autor, $anio, $genero))->save();
    } elseif ($tipo === 'revista') {
        $edicion = $_POST['edicion'] ?? '';
        (new Revista($titulo, $autor, $anio, $edicion))->save();
    }
}

if ($_SERVER['REQUEST_METHOD'] === 'GET') {
    header('Content-Type: application/json');
    echo json_encode(Publicacion::getAll());
}

if ($_SERVER['REQUEST_METHOD'] === 'DELETE') {
    parse_str(file_get_contents("php://input"), $_DELETE);
    $titulo = $_DELETE['titulo'] ?? '';
    Publicacion::delete($titulo);
}
